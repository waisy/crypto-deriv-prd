<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derivatives Exchange Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .size-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .size-buttons .btn-small {
            flex: 1;
            font-size: 0.8rem;
        }
        
        .system-health {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insurance-fund {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 4px;
            background: #1a1f2e;
            border: 1px solid #2a2f3e;
        }
        
        .insurance-fund label {
            color: #8892b0;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .insurance-fund span {
            color: #00d4aa;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .insurance-fund.at-risk {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }
        
        .insurance-fund.at-risk span {
            color: #ff4757;
        }
        
        .orders-section {
            margin-bottom: 15px;
        }
        
        .orders-container {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 3px;
            background: #1a1f2e;
            border-radius: 4px;
            border: 1px solid #2a2f3e;
            font-size: 0.85rem;
        }
        
        .order-details {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }
        
        .order-side {
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .order-side.buy {
            color: #00d4aa;
        }
        
        .order-side.sell {
            color: #ff4757;
        }
        
        .order-type {
            color: #8892b0;
            font-size: 0.75rem;
            background: #0a0e1a;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #2a2f3e;
        }
        
        .order-cancel {
            background: #ff4757;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        
        .order-cancel:hover {
            opacity: 0.8;
        }
        
        .no-orders {
            text-align: center;
            color: #8892b0;
            font-style: italic;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>Derivatives Exchange Simulator</h1>
            <div class="price-display">
                <div class="mark-price" id="markPrice">$45,000.00</div>
            </div>
            <div class="system-health">
                <div class="insurance-fund" id="insuranceFund" onclick="window.open('/insurance-fund.html', '_blank')" style="cursor: pointer; transition: opacity 0.3s;" title="Click to view Insurance Fund History">
                    <label>Insurance Fund:</label>
                    <span id="insuranceFundBalance">$1,000,000</span>
                </div>
                <a href="/insurance-fund.html" target="_blank" style="color: #3498db; text-decoration: none; font-size: 0.9rem; margin-left: 10px;">üìä History</a>
            </div>
                                <div class="user-tabs">
                        <div class="user-tab active" data-user="bob">Bob</div>
                        <div class="user-tab" data-user="eve">Eve</div>
                    </div>
        </header>

        <main class="main-grid">
            <!-- Left Panel - Trading -->
            <div class="panel">
                <h3>Trading</h3>
                
                <div class="user-switcher">
                    <label>Active User:</label>
                                            <div id="currentUser">Bob</div>
                </div>

                <div class="side-buttons">
                    <div class="btn-side buy active" data-side="buy">BUY</div>
                    <div class="btn-side sell" data-side="sell">SELL</div>
                </div>

                <form id="orderForm">
                    <div class="form-row">
                        <label>Order Type</label>
                        <select id="orderType">
                            <option value="limit">Limit</option>
                            <option value="market">Market</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>Size (BTC)</label>
                        <input type="number" id="orderSize" step="0.001" min="0.001" value="0.001" placeholder="0.001">
                        <div class="size-buttons">
                            <button type="button" class="btn-small" onclick="setSize(0.001)">0.001</button>
                            <button type="button" class="btn-small" onclick="setSize(0.01)">0.01</button>
                            <button type="button" class="btn-small" onclick="setSize(0.1)">0.1</button>
                            <button type="button" class="btn-small" onclick="setSize(1.0)">1.0</button>
                        </div>
                    </div>

                    <div class="form-row" id="priceRow">
                        <label>Price (USD)</label>
                        <input type="number" id="orderPrice" step="0.01" min="1" placeholder="45000">
                    </div>

                    <div class="form-row">
                        <label>Leverage</label>
                        <select id="leverage">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10" selected>10x</option>
                            <option value="20">20x</option>
                            <option value="50">50x</option>
                            <option value="100">100x</option>
                        </select>
                    </div>

                    <div class="margin-info" id="marginInfo">
                        Margin Required: $0.00
                    </div>

                    <button type="submit" class="btn-primary" id="placeOrderBtn">
                        Place Buy Order
                    </button>
                </form>

                <h4>Quick Actions</h4>
                <div class="form-row">
                    <label>Update Mark Price</label>
                    <input type="number" id="newMarkPrice" step="0.01" placeholder="New price">
                    <button class="btn-secondary" onclick="updateMarkPrice()">Update Price</button>
                </div>
            </div>

            <!-- Center Panel - Order Book & Trades -->
            <div class="panel center-panel">
                <div class="orderbook-section">
                    <h3>Order Book <span class="orderbook-hint">Click to trade</span></h3>
                    <div class="orderbook-mini">
                        <div class="asks" id="asks">
                            <h4>Asks</h4>
                            <div class="no-orders">No sell orders</div>
                        </div>
                        
                        <div class="spread-mini" id="spread">
                            Spread: -
                        </div>
                        
                        <div class="bids" id="bids">
                            <h4>Bids</h4>
                            <div class="no-orders">No buy orders</div>
                        </div>
                    </div>
                </div>

                <div class="position-section">
                    <h3>Positions</h3>
                    <div class="table-container">
                        <table class="positions-table" id="positionsTable">
                            <thead>
                                <tr>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry Price</th>
                                    <th>Mark Price</th>
                                    <th>Liq Price</th>
                                    <th>PnL</th>
                                    <th>RoE</th>
                                </tr>
                            </thead>
                            <tbody id="positionInfo">
                                <tr class="no-data-row">
                                    <td colspan="7" class="no-position">No open positions</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="orders-section">
                    <h3>Open Orders</h3>
                    <div class="table-container">
                        <table class="orders-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Price</th>
                                    <th>Filled</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="openOrders">
                                <tr class="no-data-row">
                                    <td colspan="6" class="no-orders">No open orders</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Panel - User & Trade Info -->
            <div class="panel">
                <h3>Account</h3>
                <div class="account-info" id="userInfo">
                    <div>Equity: <span class="value">$100,000.00</span></div>
                    <div>Available: <span class="value">$100,000.00</span></div>
                    <div>Used Margin: <span class="value">$0.00</span></div>
                    <div>Unrealized PnL: <span class="value">$0.00</span></div>
                    <div>Leverage: <span class="value">10x</span></div>
                    <div>Margin Ratio: <span class="value">N/A</span></div>
                </div>

                <div class="trades-section">
                    <h3>Recent Trades</h3>
                    <div class="trades-container" id="trades">
                        <div class="no-trades">No recent trades</div>
                    </div>
                </div>
                
                <div class="adl-section">
                    <h3>ADL Ranking</h3>
                    <div class="adl-queue" id="adlQueue">
                        <div class="no-adl">No profitable positions</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/decimal.js@10.3.1/decimal.min.js"></script>
    <script>
        const ws = new WebSocket(`ws://${window.location.host}`);
        let currentUser = 'bob';
        let state = {};

        ws.onopen = () => {
            console.log('Connected to exchange');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.error) {
                showError(data.error);
                return;
            }

            if (data.type === 'init' || data.type === 'update') {
                state = data.state;
                updateUI();
                if(data.order && data.order.status === 'REJECTED') {
                    showError(data.order.rejectReason);
                }
                if (data.liquidations && data.liquidations.length > 0) {
                    data.liquidations.forEach(liq => {
                        showNotification(`User ${liq.userId} was liquidated.`, 'error');
                    });
                }
            }
        };

        function switchUser(userId) {
            currentUser = userId;
            document.querySelectorAll('.user-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.user-tab[data-user="${userId}"]`).classList.add('active');
            updateUI(); // Refresh UI for new user
        }
        
        document.querySelectorAll('.user-tab').forEach(tab => {
            tab.addEventListener('click', () => switchUser(tab.dataset.user));
        });

        // --- Utility Functions ---
        function formatBTCAmount(amount) {
            // Format BTC amounts to 3 decimal places (minimum order size is 0.001)
            const decimal = new Decimal(amount);
            return decimal.toFixed(3);
        }
        
        function formatPrice(price) {
            // Format USD prices to 2 decimal places with proper comma formatting
            const decimal = new Decimal(price);
            return decimal.toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // --- UI Update Functions ---
        function updateUI() {
            if (!state) return;

            updatePriceInfo();
            updateOrderBook();
            updateTrades();
            updateUserInfo();
            updatePositionInfo();
            updateOpenOrders();
            updateInsuranceFund();
            updateADLQueue();
            
            // Update leverage dropdown based on user's current setting
            const user = state.users.find(u => u.id === currentUser);
            if(user) {
                document.getElementById('leverage').value = user.leverage;
            }
            
            // Update margin info on any change
            updateMarginInfo();
            updateAggressivePrice();
        }
        
        function updatePriceInfo() {
            document.getElementById('markPrice').textContent = `$${new Decimal(state.markPrice).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const spread = state.orderBook.spread;
            document.getElementById('spread').textContent = spread ? `Spread: $${new Decimal(spread).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'Spread: -';
        }

        function updateOrderBook() {
            const asksContainer = document.getElementById('asks');
            const bidsContainer = document.getElementById('bids');
            const orderBook = state.orderBook;
            
            asksContainer.innerHTML = '<h4>Asks</h4>';
            bidsContainer.innerHTML = '<h4>Bids</h4>';
            
            if (orderBook.asks.length === 0) {
                asksContainer.innerHTML += '<div class="no-orders">No sell orders</div>';
            } else {
                orderBook.asks.forEach(level => {
                    const el = document.createElement('div');
                    el.className = 'order-level ask clickable';
                    el.innerHTML = `<span class="price">$${formatPrice(level.price)}</span> <span class="size">${formatBTCAmount(level.size)}</span>`;
                    el.onclick = () => { 
                        setPrice(level.price);
                        setSize(level.size);
                    };
                    asksContainer.appendChild(el);
                });
            }

            if (orderBook.bids.length === 0) {
                bidsContainer.innerHTML += '<div class="no-orders">No buy orders</div>';
            } else {
                orderBook.bids.forEach(level => {
                    const el = document.createElement('div');
                    el.className = 'order-level bid clickable';
                    el.innerHTML = `<span class="price">$${formatPrice(level.price)}</span> <span class="size">${formatBTCAmount(level.size)}</span>`;
                    el.onclick = () => {
                        setPrice(level.price);
                        setSize(level.size);
                    };
                    bidsContainer.appendChild(el);
                });
            }
        }

        function updateTrades() {
            const tradesContainer = document.getElementById('trades');
            tradesContainer.innerHTML = '<h4>Recent Trades</h4>';
            
            if (!state.trades || state.trades.length === 0) {
                tradesContainer.innerHTML += '<div class="no-trades">No recent trades</div>';
                return;
            }

            state.trades.slice().reverse().forEach(trade => {
                const el = document.createElement('div');
                el.className = `trade-row`; // Side is not available in trade object
                el.innerHTML = `
                    <span class="price">$${formatPrice(trade.price)}</span>
                    <span class="size">${formatBTCAmount(trade.size)}</span>
                    <span class="time">${new Date(trade.timestamp).toLocaleTimeString()}</span>
                `;
                tradesContainer.appendChild(el);
            });
        }
        
        function updateUserInfo() {
            const user = state.users.find(u => u.id === currentUser);
            if (!user) return;
            
            const position = state.positions.find(p => p.userId === currentUser);
            document.getElementById('currentUser').textContent = user.name;
            const pnl = position ? new Decimal(position.unrealizedPnL) : new Decimal(0);
            const pnlClass = pnl.isPositive() && !pnl.isZero() ? 'pnl-positive' : (pnl.isNegative() ? 'pnl-negative' : '');
            
            const marginRatio = user.marginRatio !== 'N/A' ? new Decimal(user.marginRatio).toNumber() : null;
            let marginRatioClass = '';
            if (marginRatio !== null) {
                if (marginRatio <= 105) marginRatioClass = 'value-danger';
                else if (marginRatio <= 120) marginRatioClass = 'value-warning';
                else if (marginRatio <= 150) marginRatioClass = 'value-caution';
            }

            document.getElementById('userInfo').innerHTML = `
                <div class="user-info">
                    <div class="info-row">
                        <span class="info-label">Equity</span>
                        <span class="info-value">$${new Decimal(user.equity).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Available</span>
                        <span class="info-value">$${new Decimal(user.availableBalance).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Used Margin</span>
                        <span class="info-value">$${new Decimal(user.usedMargin).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Unrealized PnL</span>
                        <span class="info-value ${pnlClass}">$${pnl.toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Leverage</span>
                        <span class="info-value">${user.leverage}x</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Margin Ratio</span>
                        <span class="info-value ${marginRatioClass}">${marginRatio !== null ? marginRatio.toFixed(2) + '%' : 'N/A'}</span>
                    </div>
                </div>
            `;
        }
        
        function updatePositionInfo() {
            const position = state.positions.find(p => p.userId === currentUser);
            const container = document.getElementById('positionInfo');

            if (!position || !position.isOpen) {
                container.innerHTML = '<tr class="no-data-row"><td colspan="7" class="no-position">No open positions</td></tr>';
                return;
            }
            
            const pnl = new Decimal(position.unrealizedPnL);
            const pnlClass = pnl.isPositive() && !pnl.isZero() ? 'pnl-positive' : (pnl.isNegative() ? 'pnl-negative' : '');
            const roe = new Decimal(position.roe);
            const roeClass = roe.isPositive() && !roe.isZero() ? 'pnl-positive' : (roe.isNegative() ? 'pnl-negative' : '');
            const sideClass = position.side === 'long' ? 'side-long' : 'side-short';
            
            // Calculate distance to liquidation
            const currentPrice = new Decimal(state.markPrice);
            const liquidationPrice = new Decimal(position.liquidationPrice);
            const distanceToLiq = currentPrice.minus(liquidationPrice).abs();
            const distancePercent = distanceToLiq.div(currentPrice).times(100);
            
            let liquidationWarning = '';
            if (distancePercent.lessThan(5)) {
                liquidationWarning = 'value-danger';
            } else if (distancePercent.lessThan(10)) {
                liquidationWarning = 'value-warning';
            }

            container.innerHTML = `
                <tr class="position-row">
                    <td class="side-cell ${sideClass}">${position.side.toUpperCase()}</td>
                    <td class="size-cell">${formatBTCAmount(position.size)} BTC</td>
                    <td class="price-cell">$${formatPrice(position.avgEntryPrice)}</td>
                    <td class="price-cell">$${formatPrice(state.markPrice)}</td>
                    <td class="price-cell ${liquidationWarning}">$${formatPrice(position.liquidationPrice)}</td>
                    <td class="pnl-cell ${pnlClass}">${pnl.isPositive() ? '+' : ''}$${formatPrice(pnl)}</td>
                    <td class="roe-cell ${roeClass}">${roe.isPositive() ? '+' : ''}${roe.toFixed(2)}%</td>
                </tr>
            `;
        }

        function updateOpenOrders() {
            const container = document.getElementById('openOrders');
            const orders = state.userOrders[currentUser] || [];
            container.innerHTML = '';
            
            if (orders.length === 0) {
                container.innerHTML = '<tr class="no-data-row"><td colspan="6" class="no-orders">No open orders</td></tr>';
                return;
            }

            orders.forEach(order => {
                const sideClass = order.side === 'buy' ? 'side-long' : 'side-short';
                const statusClass = order.status.toLowerCase().replace('_', '-');
                const filledPercent = new Decimal(order.filledSize).div(order.originalSize).times(100);
                const remainingSize = new Decimal(order.originalSize).minus(order.filledSize);
                
                const row = document.createElement('tr');
                row.className = `order-row ${statusClass}`;
                row.innerHTML = `
                    <td class="side-cell ${sideClass}">${order.side.toUpperCase()}</td>
                    <td class="size-cell">${formatBTCAmount(order.originalSize)} BTC</td>
                    <td class="price-cell">$${formatPrice(order.price)}</td>
                    <td class="filled-cell">
                        <span class="filled-amount">${formatBTCAmount(order.filledSize)}</span>
                        <span class="filled-percent">(${filledPercent.toFixed(1)}%)</span>
                    </td>
                    <td class="status-cell ${statusClass}">${order.status.replace('_', ' ')}</td>
                    <td class="action-cell">
                        <button class="cancel-btn" onclick="cancelOrder('${order.id}')" title="Cancel Order">‚úï</button>
                    </td>
                `;
                container.appendChild(row);
            });
        }
        
        function updateInsuranceFund() {
            const insuranceFund = state.insuranceFund;
            const container = document.getElementById('insuranceFund');
            const balanceEl = document.getElementById('insuranceFundBalance');
            
            if (insuranceFund) {
                const balance = new Decimal(insuranceFund.balance);
                balanceEl.textContent = `$${balance.toDP(0).toNumber().toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                
                if (insuranceFund.isAtRisk) {
                    container.classList.add('at-risk');
                    container.title = 'Insurance Fund is at risk!';
                } else {
                    container.classList.remove('at-risk');
                    container.title = 'Click to view Insurance Fund History';
                }
            }
        }
        
        function updateADLQueue() {
            const queue = state.adlQueue || [];
            const container = document.getElementById('adlQueue');
            
            if (queue.length === 0) {
                container.innerHTML = '<div class="no-adl">No profitable positions</div>';
                return;
            }
            
            container.innerHTML = '';
            queue.forEach(item => {
                const el = document.createElement('div');
                el.className = 'adl-item';
                const pnl = new Decimal(item.unrealizedPnL);
                const pnlClass = pnl.isPositive() && !pnl.isZero() ? 'pnl-positive' : 'pnl-negative';
                
                const lights = '‚óè'.repeat(item.adlIndicator) + '<span class="lights-off">' + '‚óè'.repeat(5 - item.adlIndicator) + '</span>';

                el.innerHTML = `
                    <span>${item.userId}</span>
                    <span class="adl-pnl ${pnlClass}">$${new Decimal(pnl).toFixed(2)}</span>
                    <span class="adl-lights">${lights}</span>
                `;
                container.appendChild(el);
            });
        }

        function updateMarginInfo() {
            try {
                const size = document.getElementById('orderSize').value;
                const price = document.getElementById('orderPrice').value || state.markPrice;
                const leverage = document.getElementById('leverage').value;
                
                if (!size || !price || !leverage || parseFloat(size) <= 0) {
                    document.getElementById('marginInfo').textContent = 'Margin Required: $0.00';
                    return;
                }
                
                const marginRequired = new Decimal(size).times(price).dividedBy(leverage);
                document.getElementById('marginInfo').textContent = `Margin Required: $${marginRequired.toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } catch(e) {
                document.getElementById('marginInfo').textContent = 'Margin Required: Error';
            }
        }
        
        function updateAggressivePrice() {
            const orderType = document.getElementById('orderType').value;
            const priceInput = document.getElementById('orderPrice');
            if(orderType === 'market') {
                priceInput.disabled = true;
                priceInput.value = '';
                return
            }
            priceInput.disabled = false;
            
            const side = document.querySelector('.btn-side.active').dataset.side;
            const orderBook = state.orderBook;

            let aggressivePrice;
            if (side === 'buy') {
                aggressivePrice = orderBook?.asks?.length > 0 ? orderBook.asks[0].price : state.markPrice;
            } else {
                aggressivePrice = orderBook?.bids?.length > 0 ? orderBook.bids[0].price : state.markPrice;
            }
            if (aggressivePrice) {
                 priceInput.value = new Decimal(aggressivePrice).toFixed(2);
            }
        }

        // --- Event Listeners ---
        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const order = {
                type: 'place_order',
                userId: currentUser,
                side: document.querySelector('.btn-side.active').dataset.side,
                size: document.getElementById('orderSize').value,
                price: document.getElementById('orderPrice').value,
                orderType: document.getElementById('orderType').value,
                leverage: parseInt(document.getElementById('leverage').value)
            };
            
            if (order.orderType === 'limit' && !order.price) {
                showError("Please enter a valid price for limit orders");
                return;
            }

            ws.send(JSON.stringify(order));
        });

        document.querySelectorAll('.btn-side').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn-side').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const side = btn.dataset.side;
                document.getElementById('placeOrderBtn').textContent = `Place ${side.charAt(0).toUpperCase() + side.slice(1)} Order`;
                document.getElementById('placeOrderBtn').className = `btn-primary ${side}`;
                updateAggressivePrice();
            });
        });

        document.getElementById('orderType').addEventListener('change', updateAggressivePrice);
        document.getElementById('orderSize').addEventListener('input', updateMarginInfo);
        document.getElementById('orderPrice').addEventListener('input', updateMarginInfo);
        document.getElementById('leverage').addEventListener('change', () => {
             updateMarginInfo();
             ws.send(JSON.stringify({ type: 'update_leverage', userId: currentUser, leverage: parseInt(document.getElementById('leverage').value) }));
        });

        function setPrice(price) {
            document.getElementById('orderPrice').value = new Decimal(price).toFixed(2);
            updateMarginInfo();
        }

        function setSize(size) {
            document.getElementById('orderSize').value = formatBTCAmount(size);
            updateMarginInfo();
        }

        function cancelOrder(orderId) {
            ws.send(JSON.stringify({ type: 'cancel_order', orderId }));
        }

        function updateMarkPrice() {
            const price = document.getElementById('newMarkPrice').value;
            if (price) {
                ws.send(JSON.stringify({ type: 'update_mark_price', price: parseFloat(price) }));
            }
        }

        function showError(message) {
            console.error(message);
            // Could add a toast notification here
        }
        
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // Could add a toast notification here
        }

        // Initial setup
        document.querySelector(`.user-tab[data-user="${currentUser}"]`).classList.add('active');
        document.getElementById('currentUser').textContent = 'Bob';

    </script>
</body>
</html> 