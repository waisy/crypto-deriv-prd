<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derivatives Exchange Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .size-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .size-buttons .btn-small {
            flex: 1;
            font-size: 0.8rem;
        }
        
        .system-health {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insurance-fund {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 4px;
            background: #1a1f2e;
            border: 1px solid #2a2f3e;
        }
        
        .insurance-fund label {
            color: #8892b0;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .insurance-fund span {
            color: #00d4aa;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .insurance-fund.at-risk {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }
        
        .insurance-fund.at-risk span {
            color: #ff4757;
        }
        
        .orders-section {
            margin-bottom: 15px;
        }
        
        .orders-container {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 3px;
            background: #1a1f2e;
            border-radius: 4px;
            border: 1px solid #2a2f3e;
            font-size: 0.85rem;
        }
        
        .order-details {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }
        
        .order-side {
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .order-side.buy {
            color: #00d4aa;
        }
        
        .order-side.sell {
            color: #ff4757;
        }
        
        .order-type {
            color: #8892b0;
            font-size: 0.75rem;
            background: #0a0e1a;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #2a2f3e;
        }
        
        .order-cancel {
            background: #ff4757;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        
        .order-cancel:hover {
            opacity: 0.8;
        }
        
        .no-orders {
            text-align: center;
            color: #8892b0;
            font-style: italic;
            padding: 10px;
        }

        /* Liquidation Engine Styles */
        .liquidation-engine-section {
            margin-top: 20px;
        }

        .liquidation-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 5px;
            border: 1px solid #2a2f3e;
        }

        .summary-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #8892b0;
        }

        .stat-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #ffffff;
        }

        .liquidation-engine-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .liquidation-engine-table th,
        .liquidation-engine-table td {
            padding: 8px 4px;
            text-align: right;
            border-bottom: 1px solid #2a2f3e;
        }

        .liquidation-engine-table th:first-child,
        .liquidation-engine-table td:first-child {
            text-align: left;
        }

        .liquidation-engine-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .liquidation-controls {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 5px;
            border: 1px solid #2a2f3e;
        }

        .liquidation-controls h4 {
            margin: 0 0 10px 0;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .control-buttons button {
            flex: 1;
            padding: 6px 8px;
            font-size: 0.8rem;
        }

        .liquidation-status {
            font-size: 0.8rem;
            color: #8892b0;
            text-align: center;
            font-style: italic;
        }

        .le-side-long {
            color: #00d4aa;
            font-weight: 600;
        }

        .le-side-short {
            color: #ff4757;
            font-weight: 600;
        }

        .le-pnl-positive {
            color: #00d4aa;
        }

        .le-pnl-negative {
            color: #ff4757;
        }

        .le-status-pending {
            color: #f39c12;
        }

        .le-status-attempting {
            color: #3498db;
        }

        .le-status-failed {
            color: #ff4757;
        }

        .le-status-completed {
            color: #00d4aa;
        }

        .no-positions {
            text-align: center;
            color: #8892b0;
            font-style: italic;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>Derivatives Exchange Simulator</h1>
            <div class="price-display">
                <div class="mark-price" id="markPrice">$45,000.00</div>
            </div>
            <div class="system-health">
                <div class="insurance-fund" id="insuranceFund" onclick="window.open('/insurance-fund.html', '_blank')" style="cursor: pointer; transition: opacity 0.3s;" title="Click to view Insurance Fund History">
                    <label>Insurance Fund:</label>
                    <span id="insuranceFundBalance">$1,000,000</span>
                </div>
                <a href="/insurance-fund.html" target="_blank" style="color: #3498db; text-decoration: none; font-size: 0.9rem; margin-left: 10px;">📊 History</a>
            </div>
                                <div class="user-tabs">
                        <div class="user-tab active" data-user="bob">Bob</div>
                        <div class="user-tab" data-user="eve">Eve</div>
                    </div>
        </header>

        <main class="main-grid">
            <!-- Left Panel - Trading -->
            <div class="panel">
                <h3>Trading</h3>
                
                <div class="user-switcher">
                    <label>Active User:</label>
                                            <div id="currentUser">Bob</div>
                </div>

                <div class="side-buttons">
                    <div class="btn-side buy active" data-side="buy">BUY</div>
                    <div class="btn-side sell" data-side="sell">SELL</div>
                </div>

                <form id="orderForm">
                    <div class="form-row">
                        <label>Order Type</label>
                        <select id="orderType">
                            <option value="limit">Limit</option>
                            <option value="market">Market</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label>Size (BTC)</label>
                        <input type="text" id="orderSize" value="0.001" placeholder="0.001">
                        <div class="size-buttons">
                            <button type="button" class="btn-small" onclick="setSize(0.001)">0.001</button>
                            <button type="button" class="btn-small" onclick="setSize(0.01)">0.01</button>
                            <button type="button" class="btn-small" onclick="setSize(0.1)">0.1</button>
                            <button type="button" class="btn-small" onclick="setSize(1.0)">1.0</button>
                        </div>
                    </div>

                    <div class="form-row" id="priceRow">
                        <label>Price (USD)</label>
                        <input type="text" id="orderPrice" placeholder="45,000.00">
                    </div>

                    <div class="form-row">
                        <label>Leverage</label>
                        <select id="leverage">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10" selected>10x</option>
                            <option value="20">20x</option>
                            <option value="50">50x</option>
                            <option value="100">100x</option>
                        </select>
                    </div>

                    <div class="margin-info" id="marginInfo">
                        Margin Required: $0.00
                    </div>

                    <button type="submit" class="btn-primary" id="placeOrderBtn">
                        Place Buy Order
                    </button>
                </form>

                <h4>Quick Actions</h4>
                <div class="form-row">
                    <label>Update Mark Price</label>
                    <input type="text" id="newMarkPrice" placeholder="e.g. 47,500.00">
                    <button class="btn-secondary" onclick="updateMarkPrice()">Update Price</button>
                </div>
                <div class="form-row">
                    <label>Quick Adjustments</label>
                    <div class="price-adjustment-buttons">
                        <button class="btn-adjustment down" onclick="adjustMarkPrice(-10)" title="Down 10%">-10%</button>
                        <button class="btn-adjustment down" onclick="adjustMarkPrice(-5)" title="Down 5%">-5%</button>
                        <button class="btn-adjustment down" onclick="adjustMarkPrice(-1)" title="Down 1%">-1%</button>
                        <button class="btn-adjustment up" onclick="adjustMarkPrice(1)" title="Up 1%">+1%</button>
                        <button class="btn-adjustment up" onclick="adjustMarkPrice(5)" title="Up 5%">+5%</button>
                        <button class="btn-adjustment up" onclick="adjustMarkPrice(10)" title="Up 10%">+10%</button>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Order Book & Trades -->
            <div class="panel center-panel">
                <div class="orderbook-section">
                    <h3>Order Book <span class="orderbook-hint">Click to trade</span></h3>
                    <div class="orderbook-mini">
                        <div class="asks" id="asks">
                            <h4>Asks</h4>
                            <div class="no-orders">No sell orders</div>
                        </div>
                        
                        <div class="spread-mini" id="spread">
                            Spread: -
                        </div>
                        
                        <div class="bids" id="bids">
                            <h4>Bids</h4>
                            <div class="no-orders">No buy orders</div>
                        </div>
                    </div>
                </div>

                <div class="position-section">
                    <h3>Positions</h3>
                    <div class="table-container">
                        <table class="positions-table" id="positionsTable">
                            <thead>
                                <tr>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry Price</th>
                                    <th>Mark Price</th>
                                    <th>Liq Price</th>
                                    <th>PnL</th>
                                    <th>RoE</th>
                                </tr>
                            </thead>
                            <tbody id="positionInfo">
                                <tr class="no-data-row">
                                    <td colspan="7" class="no-position">No open positions</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="orders-section">
                    <h3>Open Orders</h3>
                    <div class="table-container">
                        <table class="orders-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Price</th>
                                    <th>Filled</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="openOrders">
                                <tr class="no-data-row">
                                    <td colspan="6" class="no-orders">No open orders</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Panel - User & Trade Info -->
            <div class="panel">
                <h3>Account</h3>
                <div class="account-info" id="userInfo">
                    <div>Equity: <span class="value">$100,000.00</span></div>
                    <div>Available: <span class="value">$100,000.00</span></div>
                    <div>Used Margin: <span class="value">$0.00</span></div>
                    <div>Unrealized PnL: <span class="value">$0.00</span></div>
                    <div>Leverage: <span class="value">10x</span></div>
                    <div>Margin Ratio: <span class="value">N/A</span></div>
                </div>

                <div class="trades-section">
                    <h3>Recent Trades</h3>
                    <div class="table-container">
                        <table class="trades-table" id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Size</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="trades">
                                <tr class="no-data-row">
                                    <td colspan="3" class="no-trades">No recent trades</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="adl-section">
                    <h3>ADL Ranking</h3>
                    <div class="adl-queue" id="adlQueue">
                        <div class="no-adl">No profitable positions</div>
                    </div>
                </div>

                <div class="liquidation-engine-section">
                    <h3>Liquidation Engine</h3>
                    <div class="liquidation-summary" id="liquidationSummary">
                        <div class="summary-stat">
                            <span class="stat-label">Positions:</span>
                            <span class="stat-value" id="lePositionCount">0</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Total P&L:</span>
                            <span class="stat-value" id="leTotalPnL">$0.00</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">IF Exposure:</span>
                            <span class="stat-value" id="leIfExposure">$0.00</span>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="liquidation-engine-table" id="liquidationEngineTable">
                            <thead>
                                <tr>
                                    <th>Side</th>
                                    <th>Size</th>
                                    <th>Entry Price</th>
                                    <th>Mark Price</th>
                                    <th>P&L</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="liquidationEnginePositions">
                                <tr class="no-data-row">
                                    <td colspan="7" class="no-positions">No liquidation positions</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="liquidation-controls">
                        <h4>Manual Controls</h4>
                        <div class="control-buttons">
                            <button class="btn-secondary" onclick="executeLiquidationStep('orderbook')" disabled id="orderbookBtn">
                                Try Order Book
                            </button>
                            <button class="btn-secondary" onclick="executeLiquidationStep('adl')" disabled id="adlBtn">
                                Execute ADL
                            </button>
                            <button class="btn-secondary" onclick="executeLiquidationStep('force')" disabled id="forceBtn">
                                Force Close
                            </button>
                        </div>
                        <div class="liquidation-status" id="liquidationStatus">
                            Ready for liquidation operations
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/decimal.js@10.3.1/decimal.min.js"></script>
    <script>
        const ws = new WebSocket(`ws://${window.location.host}`);
        let currentUser = 'bob';
        let state = {};

        ws.onopen = () => {
            console.log('Connected to exchange');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.error) {
                showError(data.error);
                return;
            }

            if (data.type === 'init' || data.type === 'update') {
                state = data.state;
                updateUI();
                if(data.order && data.order.status === 'REJECTED') {
                    showError(data.order.rejectReason);
                }
                if (data.liquidations && data.liquidations.length > 0) {
                    data.liquidations.forEach(liq => {
                        showNotification(`User ${liq.userId} was liquidated.`, 'error');
                    });
                }
            }
        };

        function switchUser(userId) {
            currentUser = userId;
            document.querySelectorAll('.user-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.user-tab[data-user="${userId}"]`).classList.add('active');
            updateUI(); // Refresh UI for new user
        }
        
        document.querySelectorAll('.user-tab').forEach(tab => {
            tab.addEventListener('click', () => switchUser(tab.dataset.user));
        });

        // --- Utility Functions ---
        function formatBTCAmount(amount) {
            // Format BTC amounts to 3 decimal places (minimum order size is 0.001)
            try {
                if (!amount && amount !== 0) return '0.000';
                // Clean the input before creating Decimal
                const cleanAmount = typeof amount === 'string' ? 
                    amount.replace(/[^0-9.-]/g, '') : amount;
                const decimal = new Decimal(cleanAmount);
                return decimal.toFixed(3);
            } catch (e) {
                console.error('Error formatting BTC amount:', e, 'amount:', amount);
                return '0.000';
            }
        }
        
        function formatPrice(price) {
            // Format USD prices to 2 decimal places with proper comma formatting
            try {
                if (!price && price !== 0) return '0.00';
                // Clean the input before creating Decimal
                const cleanPrice = typeof price === 'string' ? 
                    price.replace(/[^0-9.-]/g, '') : price;
                const decimal = new Decimal(cleanPrice);
                return decimal.toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } catch (e) {
                console.error('Error formatting price:', e, 'price:', price);
                return '0.00';
            }
        }

        // --- Input Formatting Functions ---
        function formatNumberInput(value, type) {
            if (!value || value === '' || value === null || value === undefined) return '';
            
            try {
                // Clean the value first - remove all non-numeric characters except decimal point
                let cleanValue = value.toString().replace(/[^0-9.]/g, '');
                
                // Handle multiple decimal points by keeping only the first one
                const decimalParts = cleanValue.split('.');
                if (decimalParts.length > 2) {
                    cleanValue = decimalParts[0] + '.' + decimalParts.slice(1).join('');
                }
                
                const num = parseFloat(cleanValue);
                if (isNaN(num) || num < 0) return '';
                
                if (type === 'btc') {
                    // Format BTC amounts to 3 decimal places
                    return num.toFixed(3);
                } else if (type === 'price') {
                    // Format USD prices with commas and 2 decimal places
                    return num.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
                return cleanValue;
            } catch (e) {
                console.error('Error formatting number input:', e, 'value:', value);
                return '';
            }
        }
        
        function parseNumberInput(value) {
            // Remove commas and other formatting for calculations
            if (!value || value === '' || value === null || value === undefined) return '';
            
            try {
                // Clean the value - remove all non-numeric characters except decimal point
                let cleanValue = value.toString().replace(/[^0-9.]/g, '');
                
                // Handle multiple decimal points by keeping only the first one
                const decimalParts = cleanValue.split('.');
                if (decimalParts.length > 2) {
                    cleanValue = decimalParts[0] + '.' + decimalParts.slice(1).join('');
                }
                
                return cleanValue;
            } catch (e) {
                console.error('Error parsing number input:', e, 'value:', value);
                return '';
            }
        }
        
        function setupInputFormatting(inputId, type) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            // Store the original value without formatting for calculations
            let lastValidValue = input.value;
            
            // Format on blur (when user leaves the field)
            input.addEventListener('blur', function() {
                const rawValue = parseNumberInput(this.value);
                if (rawValue !== '') {
                    const formatted = formatNumberInput(rawValue, type);
                    this.value = formatted;
                    lastValidValue = rawValue;
                }
            });
            
            // Remove formatting on focus (when user enters the field)
            input.addEventListener('focus', function() {
                const rawValue = parseNumberInput(this.value);
                this.value = rawValue;
            });
            
            // Validate input as user types
            input.addEventListener('input', function() {
                const rawValue = parseNumberInput(this.value);
                
                // For calculations, use the raw value
                lastValidValue = rawValue;
                
                // Update any dependent calculations
                if (inputId === 'orderSize' || inputId === 'orderPrice') {
                    updateMarginInfo();
                }
            });
            
            // Helper function to get the raw number value
            input.getRawValue = function() {
                return parseNumberInput(this.value);
            };
        }

        // --- UI Update Functions ---
        function updateUI() {
            if (!state) return;

            updatePriceInfo();
            updateOrderBook();
            updateTrades();
            updateUserInfo();
            updatePositionInfo();
            updateOpenOrders();
            updateInsuranceFund();
            updateADLQueue();
            updateLiquidationEngine();
            
            // Update leverage dropdown based on user's current setting
            const user = state.users.find(u => u.id === currentUser);
            if(user) {
                document.getElementById('leverage').value = user.leverage;
            }
            
            // Update margin info on any change
            updateMarginInfo();
            updateAggressivePrice();
        }
        
        function updatePriceInfo() {
            // Clean price data before creating Decimals
            const cleanMarkPrice = typeof state.markPrice === 'string' ? 
                state.markPrice.replace(/[^0-9.-]/g, '') : state.markPrice;
            document.getElementById('markPrice').textContent = `$${new Decimal(cleanMarkPrice || 0).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            const spread = state.orderBook.spread;
            if (spread) {
                const cleanSpread = typeof spread === 'string' ? 
                    spread.replace(/[^0-9.-]/g, '') : spread;
                document.getElementById('spread').textContent = `Spread: $${new Decimal(cleanSpread || 0).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } else {
                document.getElementById('spread').textContent = 'Spread: -';
            }
        }

        function updateOrderBook() {
            const asksContainer = document.getElementById('asks');
            const bidsContainer = document.getElementById('bids');
            const orderBook = state.orderBook;
            
            asksContainer.innerHTML = '<h4>Asks</h4>';
            bidsContainer.innerHTML = '<h4>Bids</h4>';
            
            if (orderBook.asks.length === 0) {
                asksContainer.innerHTML += '<div class="no-orders">No sell orders</div>';
            } else {
                orderBook.asks.forEach(level => {
                    const el = document.createElement('div');
                    el.className = 'order-level ask clickable';
                    el.innerHTML = `<span class="price">$${formatPrice(level.price)}</span> <span class="size">${formatBTCAmount(level.size)}</span>`;
                    el.onclick = () => { 
                        // Click on ASK = BUY to aggress it
                        setSide('buy');
                        setPrice(level.price);
                        setSize(level.size);
                    };
                    asksContainer.appendChild(el);
                });
            }

            if (orderBook.bids.length === 0) {
                bidsContainer.innerHTML += '<div class="no-orders">No buy orders</div>';
            } else {
                orderBook.bids.forEach(level => {
                    const el = document.createElement('div');
                    el.className = 'order-level bid clickable';
                    el.innerHTML = `<span class="price">$${formatPrice(level.price)}</span> <span class="size">${formatBTCAmount(level.size)}</span>`;
                    el.onclick = () => {
                        // Click on BID = SELL to aggress it
                        setSide('sell');
                        setPrice(level.price);
                        setSize(level.size);
                    };
                    bidsContainer.appendChild(el);
                });
            }
        }

        function updateTrades() {
            const tradesContainer = document.getElementById('trades');
            tradesContainer.innerHTML = '';
            
            if (!state.trades || state.trades.length === 0) {
                tradesContainer.innerHTML = '<tr class="no-data-row"><td colspan="3" class="no-trades">No recent trades</td></tr>';
                return;
            }

            // Show most recent trades first (reverse order)
            state.trades.slice().reverse().slice(0, 10).forEach(trade => {
                // Determine trade direction (buy/sell) based on buyer/seller
                const currentUserId = currentUser;
                const isBuyTrade = trade.buyUserId === currentUserId;
                const isSellTrade = trade.sellUserId === currentUserId;
                
                let tradeClass = 'trade-neutral';
                if (isBuyTrade) tradeClass = 'trade-buy';
                if (isSellTrade) tradeClass = 'trade-sell';
                
                const row = document.createElement('tr');
                row.className = `trade-row ${tradeClass}`;
                row.innerHTML = `
                    <td class="price-cell">$${formatPrice(trade.price)}</td>
                    <td class="size-cell">${formatBTCAmount(trade.size)}</td>
                    <td class="time-cell">${new Date(trade.timestamp).toLocaleTimeString()}</td>
                `;
                tradesContainer.appendChild(row);
            });
        }
        
        function updateUserInfo() {
            const user = state.users.find(u => u.id === currentUser);
            if (!user) return;
            
            const position = state.positions.find(p => p.userId === currentUser);
            document.getElementById('currentUser').textContent = user.name;
            
            // Clean user and position data before creating Decimals
            const cleanPositionPnL = position && typeof position.unrealizedPnL === 'string' ? 
                position.unrealizedPnL.replace(/[^0-9.-]/g, '') : position ? position.unrealizedPnL : 0;
            const cleanMarginRatio = user.marginRatio !== 'N/A' && typeof user.marginRatio === 'string' ? 
                user.marginRatio.replace(/[^0-9.-]/g, '') : user.marginRatio;
            const cleanEquity = typeof user.equity === 'string' ? 
                user.equity.replace(/[^0-9.-]/g, '') : user.equity;
            const cleanAvailableBalance = typeof user.availableBalance === 'string' ? 
                user.availableBalance.replace(/[^0-9.-]/g, '') : user.availableBalance;
            const cleanUsedMargin = typeof user.usedMargin === 'string' ? 
                user.usedMargin.replace(/[^0-9.-]/g, '') : user.usedMargin;
            
            const pnl = position ? new Decimal(cleanPositionPnL || 0) : new Decimal(0);
            const pnlClass = pnl.isPositive() && !pnl.isZero() ? 'pnl-positive' : (pnl.isNegative() ? 'pnl-negative' : '');
            
            const marginRatio = user.marginRatio !== 'N/A' ? new Decimal(cleanMarginRatio || 0).toNumber() : null;
            let marginRatioClass = '';
            if (marginRatio !== null) {
                if (marginRatio <= 105) marginRatioClass = 'value-danger';
                else if (marginRatio <= 120) marginRatioClass = 'value-warning';
                else if (marginRatio <= 150) marginRatioClass = 'value-caution';
            }

            document.getElementById('userInfo').innerHTML = `
                <div class="user-info">
                    <div class="info-row">
                        <span class="info-label">Equity</span>
                        <span class="info-value">$${new Decimal(cleanEquity || 0).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Available</span>
                        <span class="info-value">$${new Decimal(cleanAvailableBalance || 0).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Used Margin</span>
                        <span class="info-value">$${new Decimal(cleanUsedMargin || 0).toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Unrealized PnL</span>
                        <span class="info-value ${pnlClass}">$${pnl.toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Leverage</span>
                        <span class="info-value">${user.leverage}x</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Margin Ratio</span>
                        <span class="info-value ${marginRatioClass}">${marginRatio !== null ? marginRatio.toFixed(2) + '%' : 'N/A'}</span>
                    </div>
                </div>
            `;
        }
        
        function updatePositionInfo() {
            const position = state.positions.find(p => p.userId === currentUser);
            const container = document.getElementById('positionInfo');

            if (!position || !position.isOpen) {
                container.innerHTML = '<tr class="no-data-row"><td colspan="7" class="no-position">No open positions</td></tr>';
                return;
            }
            
            // Clean position data before creating Decimals
            const cleanPnL = typeof position.unrealizedPnL === 'string' ? 
                position.unrealizedPnL.replace(/[^0-9.-]/g, '') : position.unrealizedPnL;
            const cleanRoe = typeof position.roe === 'string' ? 
                position.roe.replace(/[^0-9.-]/g, '') : position.roe;
            const cleanMarkPrice = typeof state.markPrice === 'string' ? 
                state.markPrice.replace(/[^0-9.-]/g, '') : state.markPrice;
            const cleanLiqPrice = typeof position.liquidationPrice === 'string' ? 
                position.liquidationPrice.replace(/[^0-9.-]/g, '') : position.liquidationPrice;
            
            const pnl = new Decimal(cleanPnL || 0);
            const pnlClass = pnl.isPositive() && !pnl.isZero() ? 'pnl-positive' : (pnl.isNegative() ? 'pnl-negative' : '');
            const roe = new Decimal(cleanRoe || 0);
            const roeClass = roe.isPositive() && !roe.isZero() ? 'pnl-positive' : (roe.isNegative() ? 'pnl-negative' : '');
            const sideClass = position.side === 'long' ? 'side-long' : 'side-short';
            
            // Calculate distance to liquidation
            const currentPrice = new Decimal(cleanMarkPrice);
            const liquidationPrice = new Decimal(cleanLiqPrice);
            const distanceToLiq = currentPrice.minus(liquidationPrice).abs();
            const distancePercent = distanceToLiq.div(currentPrice).times(100);
            
            let liquidationWarning = '';
            if (distancePercent.lessThan(5)) {
                liquidationWarning = 'value-danger';
            } else if (distancePercent.lessThan(10)) {
                liquidationWarning = 'value-warning';
            }

            container.innerHTML = `
                <tr class="position-row">
                    <td class="side-cell ${sideClass}">${position.side.toUpperCase()}</td>
                    <td class="size-cell">${formatBTCAmount(position.size)} BTC</td>
                    <td class="price-cell">$${formatPrice(position.avgEntryPrice)}</td>
                    <td class="price-cell">$${formatPrice(state.markPrice)}</td>
                    <td class="price-cell ${liquidationWarning}">$${formatPrice(position.liquidationPrice)}</td>
                    <td class="pnl-cell ${pnlClass}">${pnl.isPositive() ? '+' : ''}$${formatPrice(pnl)}</td>
                    <td class="roe-cell ${roeClass}">${roe.isPositive() ? '+' : ''}${roe.toFixed(2)}%</td>
                </tr>
            `;
        }

        function updateOpenOrders() {
            const container = document.getElementById('openOrders');
            const orders = state.userOrders[currentUser] || [];
            container.innerHTML = '';
            
            if (orders.length === 0) {
                container.innerHTML = '<tr class="no-data-row"><td colspan="6" class="no-orders">No open orders</td></tr>';
                return;
            }

            orders.forEach(order => {
                const sideClass = order.side === 'buy' ? 'side-long' : 'side-short';
                const statusClass = order.status.toLowerCase().replace('_', '-');
                
                // Clean order data before creating Decimals
                const cleanFilledSize = typeof order.filledSize === 'string' ? 
                    order.filledSize.replace(/[^0-9.-]/g, '') : order.filledSize;
                const cleanOriginalSize = typeof order.originalSize === 'string' ? 
                    order.originalSize.replace(/[^0-9.-]/g, '') : order.originalSize;
                
                const filledPercent = new Decimal(cleanFilledSize || 0).div(cleanOriginalSize || 1).times(100);
                const remainingSize = new Decimal(cleanOriginalSize || 0).minus(cleanFilledSize || 0);
                
                const row = document.createElement('tr');
                row.className = `order-row ${statusClass}`;
                row.innerHTML = `
                    <td class="side-cell ${sideClass}">${order.side.toUpperCase()}</td>
                    <td class="size-cell">${formatBTCAmount(order.originalSize)} BTC</td>
                    <td class="price-cell">$${formatPrice(order.price)}</td>
                    <td class="filled-cell">
                        <span class="filled-amount">${formatBTCAmount(order.filledSize)}</span>
                        <span class="filled-percent">(${filledPercent.toFixed(1)}%)</span>
                    </td>
                    <td class="status-cell ${statusClass}">${order.status.replace('_', ' ')}</td>
                    <td class="action-cell">
                        <button class="cancel-btn" onclick="cancelOrder('${order.id}')" title="Cancel Order">✕</button>
                    </td>
                `;
                container.appendChild(row);
            });
        }
        
        function updateInsuranceFund() {
            const insuranceFund = state.insuranceFund;
            const container = document.getElementById('insuranceFund');
            const balanceEl = document.getElementById('insuranceFundBalance');
            
            if (insuranceFund) {
                // Clean insurance fund balance before creating Decimal
                const cleanBalance = typeof insuranceFund.balance === 'string' ? 
                    insuranceFund.balance.replace(/[^0-9.-]/g, '') : insuranceFund.balance;
                const balance = new Decimal(cleanBalance || 0);
                balanceEl.textContent = `$${balance.toDP(0).toNumber().toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                
                if (insuranceFund.isAtRisk) {
                    container.classList.add('at-risk');
                    container.title = 'Insurance Fund is at risk!';
                } else {
                    container.classList.remove('at-risk');
                    container.title = 'Click to view Insurance Fund History';
                }
            }
        }
        
        function updateADLQueue() {
            const queue = state.adlQueue || [];
            const container = document.getElementById('adlQueue');
            
            if (queue.length === 0) {
                container.innerHTML = '<div class="no-adl">No profitable positions</div>';
                return;
            }
            
            container.innerHTML = '';
            queue.forEach(item => {
                const el = document.createElement('div');
                el.className = 'adl-item';
                
                // Clean ADL item data before creating Decimals
                const cleanPnL = typeof item.unrealizedPnL === 'string' ? 
                    item.unrealizedPnL.replace(/[^0-9.-]/g, '') : item.unrealizedPnL;
                const pnl = new Decimal(cleanPnL || 0);
                const pnlClass = pnl.isPositive() && !pnl.isZero() ? 'pnl-positive' : 'pnl-negative';
                
                const lights = '●'.repeat(item.adlIndicator) + '<span class="lights-off">' + '●'.repeat(5 - item.adlIndicator) + '</span>';

                el.innerHTML = `
                    <span>${item.userId}</span>
                    <span class="adl-pnl ${pnlClass}">$${pnl.toFixed(2)}</span>
                    <span class="adl-lights">${lights}</span>
                `;
                container.appendChild(el);
            });
        }

        function updateMarginInfo() {
            try {
                const sizeInput = document.getElementById('orderSize');
                const priceInput = document.getElementById('orderPrice');
                
                const size = sizeInput.getRawValue ? sizeInput.getRawValue() : parseNumberInput(sizeInput.value);
                const price = priceInput.getRawValue ? priceInput.getRawValue() : parseNumberInput(priceInput.value) || state.markPrice;
                const leverage = document.getElementById('leverage').value;
                
                if (!size || !price || !leverage || parseFloat(size) <= 0) {
                    document.getElementById('marginInfo').textContent = 'Margin Required: $0.00';
                    return;
                }
                
                // Clean the values before creating Decimals
                const cleanSize = typeof size === 'string' ? size.replace(/[^0-9.-]/g, '') : size;
                const cleanPrice = typeof price === 'string' ? price.replace(/[^0-9.-]/g, '') : price;
                
                const marginRequired = new Decimal(cleanSize).times(cleanPrice).dividedBy(leverage);
                document.getElementById('marginInfo').textContent = `Margin Required: $${marginRequired.toDP(2).toNumber().toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } catch(e) {
                console.error('Error calculating margin info:', e);
                document.getElementById('marginInfo').textContent = 'Margin Required: Error';
            }
        }
        
        function updateAggressivePrice() {
            const orderType = document.getElementById('orderType').value;
            const priceInput = document.getElementById('orderPrice');
            if(orderType === 'market') {
                priceInput.disabled = true;
                priceInput.value = '';
                return
            }
            priceInput.disabled = false;
            
            const side = document.querySelector('.btn-side.active').dataset.side;
            const orderBook = state.orderBook;

            let aggressivePrice;
            if (side === 'buy') {
                aggressivePrice = orderBook?.asks?.length > 0 ? orderBook.asks[0].price : state.markPrice;
            } else {
                aggressivePrice = orderBook?.bids?.length > 0 ? orderBook.bids[0].price : state.markPrice;
            }
            if (aggressivePrice) {
                const formattedPrice = formatNumberInput(aggressivePrice, 'price');
                priceInput.value = formattedPrice;
            }
        }

        function updateLiquidationEngine() {
            if (!state.positionLiquidationEngine) return;

            const leData = state.positionLiquidationEngine;
            const summary = leData.summary;
            const positions = leData.positions;

            // Update summary statistics
            document.getElementById('lePositionCount').textContent = summary.totalPositions || 0;
            
            // Clean liquidation engine data before creating Decimals
            const cleanTotalPnL = typeof summary.totalUnrealizedPnL === 'string' ? 
                summary.totalUnrealizedPnL.replace(/[^0-9.-]/g, '') : summary.totalUnrealizedPnL;
            const cleanExposure = typeof leData.insuranceFundSufficiency.exposure === 'string' ? 
                leData.insuranceFundSufficiency.exposure.replace(/[^0-9.-]/g, '') : leData.insuranceFundSufficiency.exposure;
            
            const totalPnL = new Decimal(cleanTotalPnL || 0);
            const pnlClass = totalPnL.isPositive() && !totalPnL.isZero() ? 'le-pnl-positive' : 
                           (totalPnL.isNegative() ? 'le-pnl-negative' : '');
            document.getElementById('leTotalPnL').textContent = `$${formatPrice(summary.totalUnrealizedPnL || 0)}`;
            document.getElementById('leTotalPnL').className = `stat-value ${pnlClass}`;

            const exposure = new Decimal(cleanExposure || 0);
            const exposureClass = exposure.isPositive() ? 'le-pnl-negative' : '';
            document.getElementById('leIfExposure').textContent = `$${formatPrice(leData.insuranceFundSufficiency.exposure || 0)}`;
            document.getElementById('leIfExposure').className = `stat-value ${exposureClass}`;

            // Update positions table
            const container = document.getElementById('liquidationEnginePositions');
            container.innerHTML = '';

            if (!positions || positions.length === 0) {
                container.innerHTML = '<tr class="no-data-row"><td colspan="7" class="no-positions">No liquidation positions</td></tr>';
                
                // Disable control buttons
                document.getElementById('orderbookBtn').disabled = true;
                document.getElementById('adlBtn').disabled = true;
                document.getElementById('forceBtn').disabled = true;
                document.getElementById('liquidationStatus').textContent = 'No positions to liquidate';
            } else {
                // Enable control buttons
                document.getElementById('orderbookBtn').disabled = false;
                document.getElementById('adlBtn').disabled = false;
                document.getElementById('forceBtn').disabled = false;
                document.getElementById('liquidationStatus').textContent = `${positions.length} position(s) ready for liquidation`;

                positions.forEach(position => {
                    // Clean position data before creating Decimal
                    const cleanPositionPnL = typeof position.unrealizedPnL === 'string' ? 
                        position.unrealizedPnL.replace(/[^0-9.-]/g, '') : position.unrealizedPnL;
                    const pnl = new Decimal(cleanPositionPnL || 0);
                    const pnlClass = pnl.isPositive() && !pnl.isZero() ? 'le-pnl-positive' : 
                                   (pnl.isNegative() ? 'le-pnl-negative' : '');
                    const sideClass = position.side === 'long' ? 'le-side-long' : 'le-side-short';
                    const statusClass = `le-status-${position.status}`;
                    
                    const timeSince = Math.floor((Date.now() - position.transferTime) / 1000);
                    const timeDisplay = timeSince < 60 ? `${timeSince}s` : 
                                       timeSince < 3600 ? `${Math.floor(timeSince / 60)}m` : 
                                       `${Math.floor(timeSince / 3600)}h`;

                    const row = document.createElement('tr');
                    row.className = 'position-row';
                    row.innerHTML = `
                        <td class="side-cell ${sideClass}">${position.side.toUpperCase()}</td>
                        <td class="size-cell">${formatBTCAmount(position.size)}</td>
                        <td class="price-cell">$${formatPrice(position.entryPrice)}</td>
                        <td class="mark-price-cell">$${formatPrice(state.markPrice)}</td>
                        <td class="pnl-cell ${pnlClass}">$${formatPrice(position.unrealizedPnL)}</td>
                        <td class="status-cell ${statusClass}">${position.status.replace('_', ' ')}</td>
                        <td class="time-cell">${timeDisplay}</td>
                    `;
                    container.appendChild(row);
                });
            }

            // Update zero-sum check status
            const zeroSumCheck = leData.zeroSumCheck;
            if (!zeroSumCheck.isBalanced) {
                console.warn('Zero-sum invariant violated!', zeroSumCheck);
            }
        }

        function executeLiquidationStep(method) {
            const leData = state.positionLiquidationEngine;
            if (!leData || !leData.positions || leData.positions.length === 0) {
                showError('No positions to liquidate');
                return;
            }

            const confirmMessage = method === 'orderbook' ? 'Try to liquidate via order book?' :
                                 method === 'adl' ? 'Execute ADL liquidation?' :
                                 'Force close all positions?';
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Update status
            document.getElementById('liquidationStatus').textContent = `Executing ${method} liquidation...`;
            
            // Disable buttons temporarily
            document.getElementById('orderbookBtn').disabled = true;
            document.getElementById('adlBtn').disabled = true;
            document.getElementById('forceBtn').disabled = true;

            // Send liquidation command to server
            ws.send(JSON.stringify({
                type: 'liquidation_step',
                method: method
            }));

            // Re-enable buttons after a delay (in case no response)
            setTimeout(() => {
                document.getElementById('orderbookBtn').disabled = false;
                document.getElementById('adlBtn').disabled = false;
                document.getElementById('forceBtn').disabled = false;
            }, 3000);
        }

        // --- Event Listeners ---
        document.getElementById('orderForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const sizeInput = document.getElementById('orderSize');
            const priceInput = document.getElementById('orderPrice');
            
            const order = {
                type: 'place_order',
                userId: currentUser,
                side: document.querySelector('.btn-side.active').dataset.side,
                size: sizeInput.getRawValue ? sizeInput.getRawValue() : parseNumberInput(sizeInput.value),
                price: priceInput.getRawValue ? priceInput.getRawValue() : parseNumberInput(priceInput.value),
                orderType: document.getElementById('orderType').value,
                leverage: parseInt(document.getElementById('leverage').value)
            };
            
            if (order.orderType === 'limit' && !order.price) {
                showError("Please enter a valid price for limit orders");
                return;
            }

            ws.send(JSON.stringify(order));
        });

        document.querySelectorAll('.btn-side').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn-side').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const side = btn.dataset.side;
                document.getElementById('placeOrderBtn').textContent = `Place ${side.charAt(0).toUpperCase() + side.slice(1)} Order`;
                document.getElementById('placeOrderBtn').className = `btn-primary ${side}`;
                updateAggressivePrice();
            });
        });

        document.getElementById('orderType').addEventListener('change', updateAggressivePrice);
        document.getElementById('orderSize').addEventListener('input', updateMarginInfo);
        document.getElementById('orderPrice').addEventListener('input', updateMarginInfo);
        document.getElementById('leverage').addEventListener('change', () => {
             updateMarginInfo();
             ws.send(JSON.stringify({ type: 'update_leverage', userId: currentUser, leverage: parseInt(document.getElementById('leverage').value) }));
        });

        function setSide(side) {
            // Update side buttons
            document.querySelectorAll('.btn-side').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.btn-side[data-side="${side}"]`).classList.add('active');
            
            // Update order button text and style
            document.getElementById('placeOrderBtn').textContent = `Place ${side.charAt(0).toUpperCase() + side.slice(1)} Order`;
            document.getElementById('placeOrderBtn').className = `btn-primary ${side}`;
            
            // Update aggressive price if in limit mode
            updateAggressivePrice();
        }

        function setPrice(price) {
            const priceInput = document.getElementById('orderPrice');
            const formattedPrice = formatNumberInput(price, 'price');
            priceInput.value = formattedPrice;
            updateMarginInfo();
        }

        function setSize(size) {
            const sizeInput = document.getElementById('orderSize');
            const formattedSize = formatNumberInput(size, 'btc');
            sizeInput.value = formattedSize;
            updateMarginInfo();
        }

        function cancelOrder(orderId) {
            ws.send(JSON.stringify({ type: 'cancel_order', orderId }));
        }

        function updateMarkPrice() {
            const priceInput = document.getElementById('newMarkPrice');
            const price = priceInput.getRawValue ? priceInput.getRawValue() : parseNumberInput(priceInput.value);
            if (price) {
                ws.send(JSON.stringify({ type: 'update_mark_price', price: parseFloat(price) }));
                // Don't clear the input - user may want to update multiple times
            }
        }

        function adjustMarkPrice(percentageChange) {
            const priceInput = document.getElementById('newMarkPrice');
            let currentPrice;
            
            // Get current price from input, or use current mark price if input is empty
            const inputValue = priceInput.getRawValue ? priceInput.getRawValue() : parseNumberInput(priceInput.value);
            if (inputValue && inputValue !== '') {
                currentPrice = parseFloat(inputValue);
            } else if (state && state.markPrice) {
                currentPrice = parseFloat(state.markPrice);
            } else {
                showError('No price available to adjust');
                return;
            }
            
            // Calculate new price with percentage adjustment
            const adjustment = currentPrice * (percentageChange / 100);
            const newPrice = currentPrice + adjustment;
            
            // Update the input with the new price
            const formattedPrice = formatNumberInput(newPrice, 'price');
            priceInput.value = formattedPrice;
            
            // Automatically send the update
            ws.send(JSON.stringify({ type: 'update_mark_price', price: newPrice }));
        }

        function showError(message) {
            console.error(message);
            // Could add a toast notification here
        }
        
        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // Could add a toast notification here
        }

        // Initial setup
        document.querySelector(`.user-tab[data-user="${currentUser}"]`).classList.add('active');
        document.getElementById('currentUser').textContent = 'Bob';
        
        // Initialize input formatting
        document.addEventListener('DOMContentLoaded', function() {
            setupInputFormatting('orderSize', 'btc');
            setupInputFormatting('orderPrice', 'price');
            setupInputFormatting('newMarkPrice', 'price');
        });
        
        // Setup input formatting immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setupInputFormatting('orderSize', 'btc');
                setupInputFormatting('orderPrice', 'price');
                setupInputFormatting('newMarkPrice', 'price');
            });
        } else {
            setupInputFormatting('orderSize', 'btc');
            setupInputFormatting('orderPrice', 'price');
            setupInputFormatting('newMarkPrice', 'price');
        }

    </script>
</body>
</html> 